resources:
  - name: customer-keeper-api
    type: git
    source:
      uri: https://github.com/zackvalentine/customer-keeper-api.git
      branch: add-local-ci

  - name: customer-keeper-api-dcind-openjdk11
    type: docker-image
    source:
      repository: gcr.io/gleaming-aegis/288600/customer-keeper-api-dcind-openjdk11

  - name: final-docker-image
    type: docker-image
    source:
      repository: gcr.io/gleaming-aegis-288600/customer-keeper-api

jobs:
  - name: verify
    build_logs_to_retain: 50
    plan:
      - in_parallel:
          - get: target
            resource: customer-keeper-api
            trigger: true
          - get: customer-keeper-api-dcind-openjdk11
            passed: [build-verify-image]
            params:
              save: true
      - task: build
        privileged: true
        image: customer-keeper-api-dcind-openjdk11
        file: target/ci/tasks/build.yml
        on_success:
          put: final-docker-image
          params:
            load_file: build-output/image/tgz
            load_repository: customer-keeper-api
            load_tag: SNAPSHOT
            tag: build-output/tag

  - name: deploy-dev
    build_logs_to_retain: 50
    plan:
      - in_parallel:
          - get: target
            resource: customer-keeper-api
            trigger: true
          - get: customer-keeper-api-dcind-openjdk11
      - task: deploy
        image: gcr.gleaming-aegis-288600/customer-keeper-api
        file: target/ci/tasks/deploy.yml

  - name: build-verify-image
    build_logs_to_retain: 50
    plan:
      - get: add-local-ci
        resource: customer-keeper-api
        trigger: true
      - try:
          task: build-container
          file: add-local-ci/ci/tasks/build-container.yml
          on_success:
            put: customer-keeper-api-dcind-openjdk11
            params:
              build: add-local-ci/ci/dcind-openjdk11
              tag: docker-env/ref
              tag_as_latest: true